name: CI - CLI Integration Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Also allow manual triggering

jobs:
  cli-integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout labelle-engine
        uses: actions/checkout@v4
        with:
          path: labelle-engine

      - name: Checkout labelle-gfx (sibling dependency)
        uses: actions/checkout@v4
        with:
          repository: labelle-toolkit/labelle-gfx
          path: labelle-gfx

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Cache Zig dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/zig
          key: zig-cache-${{ runner.os }}-${{ hashFiles('**/build.zig.zon') }}
          restore-keys: |
            zig-cache-${{ runner.os }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libx11-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxext-dev \
            libxfixes-dev \
            libwayland-dev \
            libxkbcommon-dev \
            libasound2-dev \
            xvfb

      - name: Install labelle-cli
        run: |
          curl -fsSL https://labelle.games/install.sh | bash
          # Add to PATH for subsequent steps
          echo "$HOME/.labelle/bin" >> $GITHUB_PATH

      - name: Verify CLI installation
        run: |
          labelle version
          labelle help

      - name: Create test directory
        run: |
          mkdir -p test-projects
          cd test-projects

      - name: Test CLI workflow - Create raylib project
        run: |
          cd test-projects
          echo "::group::Creating raylib project"
          
          # Use labelle-cli to create a new project
          labelle init test_raylib_game --backend=raylib --ecs=zig_ecs
          
          echo "::endgroup::"

      - name: Test CLI workflow - Generate with local engine
        shell: bash
        run: |
          cd test-projects/test_raylib_game
          echo "::group::Generating build files with local engine"

          # Generate using the checked-out engine (relative path from project dir)
          # Retry to handle transient dependency fetch failures (sokol-tools-bin via Git LFS)
          set -euo pipefail
          success=0
          for attempt in 1 2 3; do
            if labelle generate --engine-path=../../labelle-engine; then
              success=1
              break
            fi
            if [ "$attempt" -lt 3 ]; then
              echo "::warning::Generate attempt $attempt failed, retrying in 10s..."
              sleep 10
            fi
          done

          if [ "$success" -ne 1 ]; then
            echo "::error::Generate failed after 3 attempts."
            exit 1
          fi

          echo "::endgroup::"

      - name: Test CLI workflow - Verify generated directory
        run: |
          BUILD_DIR="test-projects/test_raylib_game/.labelle/raylib_desktop"
          if [ ! -d "$BUILD_DIR" ]; then
            echo "::error::Generated directory '$BUILD_DIR' does not exist."
            echo "Listing .labelle/ contents for diagnostics:"
            ls -la test-projects/test_raylib_game/.labelle/ 2>/dev/null || echo "  .labelle/ directory not found"
            exit 1
          fi
          echo "Generated files:"
          ls -la "$BUILD_DIR"

      - name: Test CLI workflow - Build raylib project with generated files
        shell: bash
        run: |
          echo "::group::Building project directly from generated files"

          # Build using the generated build.zig directly (uses local engine via path dependency)
          cd test-projects/test_raylib_game/.labelle/raylib_desktop
          set -euo pipefail
          success=0
          for attempt in 1 2 3; do
            if zig build; then
              success=1
              break
            fi
            if [ "$attempt" -lt 3 ]; then
              echo "::warning::Build attempt $attempt failed, retrying in 10s..."
              sleep 10
            fi
          done

          if [ "$success" -ne 1 ]; then
            echo "::error::Build failed after 3 attempts."
            exit 1
          fi

          echo "::endgroup::"

      - name: Test CLI workflow - Run raylib project
        env:
          CI_TEST: "1"
        run: |
          echo "::group::Running project"

          # Run with xvfb for headless testing
          cd test-projects/test_raylib_game/.labelle/raylib_desktop
          xvfb-run -a zig build run

          echo "::endgroup::"

      - name: Test CLI workflow - Create sokol project
        run: |
          cd test-projects
          echo "::group::Creating sokol project"
          
          # SKIPPED: Sokol backend has sgl.setup() issue - see labelle-gfx#146
          # labelle init test_sokol_game --backend=sokol --ecs=zflecs
          
          echo "Sokol test skipped due to labelle-gfx#146"
          echo "::endgroup::"

      - name: Test CLI workflow - Multiple targets (generate)
        shell: bash
        run: |
          echo "::group::Creating project with multiple targets"

          cd test-projects
          # Create a project
          labelle init test_multi_target --backend=raylib --ecs=zig_ecs
          cd test_multi_target

          # Generate with local engine (retry for transient fetch failures)
          success=0
          for attempt in 1 2 3; do
            if labelle generate --engine-path=../../labelle-engine; then
              success=1
              break
            fi
            if [ "$attempt" -lt 3 ]; then
              echo "::warning::Generate attempt $attempt failed, retrying in 10s..."
              sleep 10
            fi
          done
          if [ "$success" -ne 1 ]; then
            echo "::error::Generate failed after 3 attempts."
            exit 1
          fi

          echo "::endgroup::"

      - name: Test CLI workflow - Multiple targets (verify)
        run: |
          BUILD_DIR="test-projects/test_multi_target/.labelle/raylib_desktop"
          if [ ! -d "$BUILD_DIR" ]; then
            echo "::error::Generated directory '$BUILD_DIR' does not exist."
            echo "Listing .labelle/ contents for diagnostics:"
            ls -la test-projects/test_multi_target/.labelle/ 2>/dev/null || echo "  .labelle/ directory not found"
            exit 1
          fi
          echo "Generated files:"
          ls -la "$BUILD_DIR"

      - name: Test CLI workflow - Multiple targets (build)
        shell: bash
        run: |
          echo "::group::Building multi-target project"

          # Build directly from generated files
          cd test-projects/test_multi_target/.labelle/raylib_desktop
          set -euo pipefail
          success=0
          for attempt in 1 2 3; do
            if zig build; then
              success=1
              break
            fi
            if [ "$attempt" -lt 3 ]; then
              echo "::warning::Build attempt $attempt failed, retrying in 10s..."
              sleep 10
            fi
          done

          if [ "$success" -ne 1 ]; then
            echo "::error::Build failed after 3 attempts."
            exit 1
          fi

          echo "::endgroup::"

      - name: Create test summary
        if: always()
        run: |
          echo "## CLI Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ CLI installation successful" >> $GITHUB_STEP_SUMMARY
          echo "✅ Project creation working" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build generation with local engine successful" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build and run working" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Projects Tested" >> $GITHUB_STEP_SUMMARY
          echo "- Raylib + zig_ecs: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Sokol + zflecs: ⏭️ Skipped (labelle-gfx#146)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CLI Commands Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`labelle init\`: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- \`labelle generate --engine-path\`: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- \`zig build\` (generated files): ✅" >> $GITHUB_STEP_SUMMARY
          echo "- \`zig build run\` (generated files): ✅" >> $GITHUB_STEP_SUMMARY
